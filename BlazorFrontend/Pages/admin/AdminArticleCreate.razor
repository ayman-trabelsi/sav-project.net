@page "/admin/articles/create"
@inject NavigationManager Navigation
@inject IHttpClientFactory ClientFactory
@inject IJSRuntime JS
@inject AuthService _authService 
@attribute [Authorize(Roles = "ResponsableSAV")]
@using Microsoft.AspNetCore.Authorization
@using Shared.Models

<h3>Créer un Article</h3>

<EditForm Model="article" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label class="form-label">Libellé</label>
        <InputText class="form-control" @bind-Value="article.Libelle" />
    </div>
    <div class="mb-3">
        <label class="form-label">Prix</label>
        <InputNumber class="form-control" @bind-Value="article.Prix" />
    </div>
    <div class="mb-3 form-check">
        <InputCheckbox class="form-check-input" @bind-Value="article.EstSousGarantie" />
        <label class="form-check-label">Sous Garantie</label>
    </div>
    <div class="mb-3">
        <label class="form-label">Image</label>
        <InputFile OnChange="HandleFileSelected" class="form-control" accept=".jpg,.jpeg,.png" />
        @if (!string.IsNullOrEmpty(article.ImageUrl))
        {
            <div class="mt-2">
                <img src="@article.ImageUrl" alt="Article image" style="max-width: 200px; max-height: 200px;" />
            </div>
        }
    </div>

    <button type="submit" class="btn btn-success">Créer</button>
    <button type="button" class="btn btn-secondary ms-2" @onclick="GoBack">Annuler</button>
</EditForm>

@code {
    private Article article = new Article();
    private IBrowserFile? selectedFile;

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        if (selectedFile != null)
        {
            // Convert the file to base64 for preview
            using var stream = selectedFile.OpenReadStream(maxAllowedSize: 10485760); // 10MB max
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            var base64 = Convert.ToBase64String(ms.ToArray());
            article.ImageUrl = $"data:{selectedFile.ContentType};base64,{base64}";
        }
    }

    // Helper method to get HttpClient with Authorization header
    private async Task<HttpClient> GetAuthorizedHttpClient()
    {
        var client = ClientFactory.CreateClient("AuthorizedClient");
        var token = await _authService.GetTokenAsync();

        if (!string.IsNullOrEmpty(token))
        {
            client.DefaultRequestHeaders.Authorization = 
                new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
        }
        return client;
    }

    private async Task HandleValidSubmit()
    {
        var client = await GetAuthorizedHttpClient();

        // If there's a file selected, upload it first
        if (selectedFile != null)
        {
            var content = new MultipartFormDataContent();
            var fileContent = new StreamContent(selectedFile.OpenReadStream());
            content.Add(fileContent, "file", selectedFile.Name);

            var uploadResponse = await client.PostAsync("api/upload", content);
            if (uploadResponse.IsSuccessStatusCode)
            {
                article.ImageUrl = await uploadResponse.Content.ReadAsStringAsync();
            }
        }

        var response = await client.PostAsJsonAsync("api/articles", article);

        if (response.IsSuccessStatusCode)
        {
            Navigation.NavigateTo("/admin/articles");
        }
        else
        {
            Console.WriteLine("Erreur lors de la création de l'article.");
        }
    }

    private void GoBack() => Navigation.NavigateTo("/admin/articles");
}
